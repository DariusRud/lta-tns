<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNS Ataskaitos Formavimas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .hardware-spin {
            animation: fast-spin 1s linear infinite;
            will-change: transform;
            transform: translateZ(0);
        }

        @keyframes fast-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 text-slate-900 relative">

    <!-- Krovimosi langas -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] flex flex-col items-center justify-center text-white text-center px-4">
        <div class="bg-white p-8 rounded-3xl flex flex-col items-center shadow-2xl max-w-sm w-full border border-slate-100">
            <div class="relative mb-6">
                <div class="w-16 h-16 border-4 border-slate-100 border-t-emerald-600 rounded-full hardware-spin"></div>
            </div>
            <p id="loadingTitle" class="text-slate-800 font-bold text-xl mb-1">Apdorojama...</p>
            <p id="loadingSubtitle" class="text-slate-500 text-sm mb-6">Laukite, nuskaitomas failas</p>
            
            <div class="mt-4 pt-4 border-t border-red-100">
                <p class="text-red-600 font-black text-[11px] uppercase tracking-wide leading-tight">
                    Įkeltas didelis failas,<br>jeigu iššoks pranešimas Wait, spausti wait
                </p>
            </div>
        </div>
    </div>

    <!-- PRISIJUNGIMO LANGAS -->
    <div id="stepLogin" class="fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center p-4">
        <div class="mb-8 text-center">
            <div class="bg-emerald-600 p-4 rounded-2xl shadow-xl shadow-emerald-200 inline-block mb-4">
                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
            </div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">TNS ataskaitos formavimas</h1>
        </div>

        <div class="bg-white p-8 md:p-10 rounded-3xl shadow-xl border border-slate-200 w-full max-w-md">
            <div id="loginError" class="hidden mb-6 p-4 rounded-xl bg-red-50 border border-red-100 text-red-600 text-sm font-semibold flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                Neteisingas vartotojas arba slaptažodis
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Vartotojas</label>
                    <input type="text" id="username" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 focus:outline-none font-bold text-slate-700 shadow-sm" placeholder="Įveskite vardą">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Slaptažodis</label>
                    <input type="password" id="password" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 focus:outline-none font-bold text-slate-700 shadow-sm" placeholder="••••••••">
                </div>
                <button id="loginBtn" class="w-full py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3 shadow-lg shadow-emerald-100 transition-all bg-emerald-600 text-white hover:bg-emerald-700 active:scale-[0.98] mt-2">
                    Prisijungti
                </button>
            </div>
        </div>
    </div>

    <!-- PAGRINDINIS TURINYS -->
    <div id="mainApp" class="hidden max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <div class="bg-emerald-600 p-3 rounded-xl shadow-lg shadow-emerald-200">
                    <i data-lucide="file-spreadsheet" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">TNS Ataskaitos Formavimas</h1>
            </div>
            <div id="stepIndicator" class="hidden md:flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-slate-300">
                <span id="stepLabel1">Failas</span>
                <i data-lucide="chevron-right" class="w-3 h-3"></i>
                <span id="stepLabel2">Laikotarpis</span>
                <i data-lucide="chevron-right" class="w-3 h-3"></i>
                <span id="stepLabel3">Rezultatas</span>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 md:p-10 min-h-[450px] flex flex-col transition-all duration-500 overflow-hidden">
            
            <!-- ŽINGSNIS 1: Instrukcija ir Įkėlimas -->
            <div id="step1" class="hidden flex-col h-full animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="mb-10 p-6 bg-emerald-50 border border-emerald-100 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="help-circle" class="w-20 h-20 text-emerald-900"></i>
                    </div>
                    <h3 class="text-sm font-bold text-emerald-800 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4"></i> 1. Sugeneruokite failą Eksportas_statika.xls
                    </h3>
                    <ul class="text-sm text-emerald-700 space-y-3 relative z-10">
                        <li class="flex items-start gap-3"><span class="bg-emerald-200 text-emerald-700 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 mt-0.5">1</span><span>Atsidarykite <a href="https://lta-eilutes.vercel.app/" target="_blank" class="underline font-bold hover:text-emerald-900 decoration-2 underline-offset-2">lta-eilutes.vercel.app</a></span></li>
                        <li class="flex items-start gap-3"><span class="bg-emerald-200 text-emerald-700 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 mt-0.5">2</span><span>Prisijunkite ir pasirinkite skiltį <strong>„Statika“</strong></span></li>
                        <li class="flex items-start gap-3"><span class="bg-emerald-200 text-emerald-700 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 mt-0.5">3</span><span>Įkelkite naujausią <strong>Uzimtumas L..xls</strong> failą</span></li>
                        <li class="flex items-start gap-3"><span class="bg-emerald-200 text-emerald-700 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 mt-0.5">4</span><span>Palaukite, kol sistema sugeneruos failą <strong class="text-emerald-600 font-extrabold uppercase tracking-tight">Eksportas_statika.xls</strong></span></li>
                    </ul>
                </div>

                <div class="flex-grow">
                    <label class="block text-sm font-bold text-slate-700 mb-3 uppercase tracking-wider">2. Įkelkite gautą failą</label>
                    <div id="dropZone" class="border-2 border-dashed border-slate-200 rounded-2xl p-16 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-400 hover:bg-emerald-50/50 transition-all bg-white group shadow-inner">
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
                        <div class="bg-slate-50 p-5 rounded-full mb-4 group-hover:bg-emerald-100 transition-colors shadow-sm pointer-events-none">
                            <i data-lucide="upload" class="text-slate-400 group-hover:text-emerald-600 w-12 h-12 transition-colors"></i>
                        </div>
                        <span class="text-slate-600 text-center font-semibold text-lg pointer-events-none">Įkelti failą čia</span>
                        <p class="text-slate-400 text-sm mt-2 pointer-events-none">Nutempkite failą arba spustelėkite</p>
                    </div>
                </div>
            </div>

            <!-- ŽINGSNIS 2: Laikotarpis -->
            <div id="step2" class="hidden flex-col flex-grow animate-in fade-in slide-in-from-right-8 duration-500">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3 text-emerald-600 font-bold bg-emerald-50 py-2 px-4 rounded-full border border-emerald-100">
                        <i data-lucide="file-check" class="w-5 h-5"></i>
                        <span id="loadedFileNameDisplay" class="text-sm truncate max-w-[200px] text-emerald-700 font-bold">Failas paruoštas</span>
                    </div>
                    <button id="changeFileBtn" class="text-xs font-bold text-slate-400 hover:text-red-500 underline uppercase tracking-widest transition-colors">Keisti</button>
                </div>
                
                <h3 class="text-2xl font-black text-slate-800 mb-2">Pasirinkite laikotarpį</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Metai</label>
                        <select id="reportYear" class="w-full p-5 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 focus:outline-none cursor-pointer font-bold text-slate-700 text-lg shadow-sm">
                            <option value="2024">2024 metai</option><option value="2025">2025 metai</option><option value="2026">2026 metai</option><option value="2027">2027 metai</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Mėnuo</label>
                        <select id="reportMonth" class="w-full p-5 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 focus:outline-none cursor-pointer font-bold text-slate-700 text-lg shadow-sm">
                            <option value="1">Sausis</option><option value="2">Vasaris</option><option value="3">Kovas</option>
                            <option value="4">Balandis</option><option value="5">Gegužė</option><option value="6">Birželis</option>
                            <option value="7">Liepa</option><option value="8">Rugpjūtis</option><option value="9">Rugsėjis</option>
                            <option value="10">Spalis</option><option value="11">Lapkritis</option><option value="12">Gruodis</option>
                        </select>
                    </div>
                </div>

                <button id="generateBtn" class="group w-full py-6 rounded-3xl font-black text-xl flex items-center justify-center gap-4 shadow-xl shadow-emerald-200 transition-all bg-emerald-600 text-white hover:bg-emerald-700 active:scale-[0.98]">
                    <i data-lucide="wand-2" class="w-7 h-7 group-hover:rotate-12 transition-transform"></i>
                    Formuoti TNS ataskaitą
                </button>
            </div>

            <!-- ŽINGSNIS 3: Rezultatas -->
            <div id="step3" class="hidden flex-col flex-grow items-center justify-center text-center animate-in zoom-in-95 duration-500">
                <div class="bg-emerald-500 p-6 rounded-full shadow-lg mb-8">
                    <i data-lucide="check" class="w-16 h-16 text-white stroke-[3]"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-3 tracking-tight">Ataskaita paruošta!</h2>
                <p id="resultInfo" class="text-slate-500 mb-10 text-lg font-medium"></p>
                <button id="restartBtn" class="w-full max-w-xs py-5 rounded-2xl font-bold text-slate-600 border-2 border-slate-100 hover:bg-slate-50 transition-all flex items-center justify-center gap-3">
                    <i data-lucide="refresh-ccw" class="w-5 h-5"></i> Nauja ataskaita
                </button>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        // Autentifikacija
        const loginBtn = document.getElementById('loginBtn');
        const stepLogin = document.getElementById('stepLogin');
        const mainApp = document.getElementById('mainApp');
        const loginError = document.getElementById('loginError');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');

        const handleLogin = () => {
            if (usernameInput.value === 'User' && passwordInput.value === 'user123') {
                stepLogin.classList.add('hidden');
                mainApp.classList.remove('hidden');
                goToStep(1);
            } else {
                loginError.classList.remove('hidden');
                setTimeout(() => loginError.classList.add('hidden'), 3000);
            }
        };
        
        [usernameInput, passwordInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        });

        loginBtn.onclick = handleLogin;

        let uploadedData = null;
        // Papildyta statusu "MB"
        const STATUSAI = ["UAB", "AB", "IĮ", "VŠĮ", "AS", "VIEŠOJI ĮSTAIGA", "MB"];

        const steps = [document.getElementById('step1'), document.getElementById('step2'), document.getElementById('step3')];
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const generateBtn = document.getElementById('generateBtn');
        const restartBtn = document.getElementById('restartBtn');
        const reportYear = document.getElementById('reportYear');
        const reportMonth = document.getElementById('reportMonth');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingSubtitle = document.getElementById('loadingSubtitle');
        const resultInfo = document.getElementById('resultInfo');
        const loadedFileNameDisplay = document.getElementById('loadedFileNameDisplay');

        const nustatytiPraeitaMenesi = () => {
            const d = new Date();
            d.setMonth(d.getMonth() - 1);
            reportYear.value = d.getFullYear();
            reportMonth.value = d.getMonth() + 1;
        };
        nustatytiPraeitaMenesi();

        function goToStep(stepNum) {
            steps.forEach((s, idx) => {
                if (idx + 1 === stepNum) { s.classList.remove('hidden'); s.classList.add('flex'); }
                else { s.classList.add('hidden'); s.classList.remove('flex'); }
            });
            lucide.createIcons();
        }

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); };

        function handleFile(file) {
            loadingTitle.innerText = "Apdorojama...";
            loadingSubtitle.innerText = "Laukite, nuskaitomas failas";
            loadingOverlay.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary', cellDates: true });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    uploadedData = XLSX.utils.sheet_to_json(sheet);
                    loadedFileNameDisplay.innerText = file.name;
                    goToStep(2);
                } catch (err) { alert('Klaida nuskaitant failą.'); }
                finally { loadingOverlay.classList.add('hidden'); }
            };
            reader.readAsBinaryString(file);
        }

        const formatuotiReklamuotoja = (tekstas) => {
            if (!tekstas) return "";
            const dalys = tekstas.split(",").map(d => d.trim());
            const pirma = dalys[0] || "";
            const antra = dalys.length > 1 ? dalys[1] : "";
            // Valome statusą (pvz., MB. -> MB)
            const antraValyta = antra.toUpperCase().replace(/\./g, "").trim();
            
            // Tikriname, ar antra dalis prasideda vienu iš žinomų statusų
            const randaStatusa = STATUSAI.some(s => antraValyta === s || antraValyta.startsWith(s + " "));
            
            return randaStatusa ? `${pirma}, ${antra.split(' ')[0].replace(/[,.]+$/, "")}` : pirma;
        };

        const gautiUzsakymoNumeri = (tekstas) => {
            if (!tekstas) return "";
            const matches = String(tekstas).match(/\b(\d{4})\b/g);
            if (!matches) return "";
            return matches[matches.length - 1]; 
        };

        const gautiPuse = (kodas, tipas) => {
            const k = String(kodas).trim().toUpperCase();
            const t = String(tipas).trim().toLowerCase();
            if (t.includes('siena') || t.includes('stotelė')) return 1;
            if (t.includes('vitrina')) return "1, 2, 3";
            const last = k.slice(-1);
            return (['B', '2'].includes(last) || k.endsWith(' B')) ? 2 : 1;
        };

        const gautiTikrusInicialus = (tekstas) => {
            if (!tekstas) return [];
            const re = /(?:^|[^A-ZĄČĘĖĮŠŲŪŽ])([A-ZĄČĘĖĮŠŲŪŽ]\.\s?[A-ZĄČĘĖĮŠŲŪŽ]\.)/g;
            const inicialai = [];
            let match;
            while ((match = re.exec(tekstas)) !== null) {
                inicialai.push(match[1].trim());
            }
            return inicialai;
        };

        generateBtn.onclick = () => {
            if (!uploadedData) return;
            loadingTitle.innerText = "Apdorojama...";
            loadingSubtitle.innerText = "Laukite, nuskaitomas failas";
            loadingOverlay.classList.remove('hidden');

            setTimeout(() => {
                try {
                    const year = reportYear.value;
                    const month = reportMonth.value.padStart(2, '0');
                    const targetPrefix = `${year}-${month}`;

                    const filtered = uploadedData.filter(row => {
                        const d = row['Data'];
                        return d && String(d).startsWith(targetPrefix);
                    });

                    const sorted = [...filtered].sort((a, b) => {
                        if (a['Kodas'] !== b['Kodas']) return String(a['Kodas']).localeCompare(String(b['Kodas']));
                        return String(a['Data']).localeCompare(String(b['Data']));
                    });

                    const groups = [];
                    if (sorted.length > 0) {
                        let curGroup = { row: sorted[0], datos: [sorted[0]['Data']] };
                        for (let i = 1; i < sorted.length; i++) {
                            const prevRow = sorted[i - 1];
                            const currRow = sorted[i];
                            const d1 = new Date(prevRow['Data']);
                            const d2 = new Date(currRow['Data']);
                            const diff = (d2 - d1) / (1000 * 60 * 60 * 24);

                            if (currRow['Kodas'] === prevRow['Kodas'] && 
                                currRow['Pardavimas'] === prevRow['Pardavimas'] && 
                                diff === 1) {
                                curGroup.datos.push(currRow['Data']);
                            } else {
                                groups.push(curGroup);
                                curGroup = { row: currRow, datos: [currRow['Data']] };
                            }
                        }
                        groups.push(curGroup);
                    }

                    const finalData = groups.map(g => {
                        const r = g.row;
                        const sDates = g.datos.sort();
                        const pStr = String(r['Pardavimas']);
                        const pLower = pStr.toLowerCase();

                        const visiInicialai = gautiTikrusInicialus(pStr);
                        const tinkamiPardavejai = visiInicialai.filter(init => {
                            const clean = init.replace(/\s/g, '').toUpperCase();
                            return clean !== 'RP.' && clean !== 'RP';
                        });
                        const pardavejas = tinkamiPardavejai.length > 0 ? tinkamiPardavejai[tinkamiPardavejai.length - 1] : "";
                        
                        const uzsNr = gautiUzsakymoNumeri(pStr);

                        let produktas = ""; 
                        const rpMatch = pStr.match(/R\.\s?P\./i);
                        
                        if (rpMatch) {
                            const rpIndex = rpMatch.index;
                            const poRP = pStr.substring(rpIndex + rpMatch[0].length).trim().replace(/^:/, "").trim();
                            
                            if (pardavejas !== "") {
                                const pardavejoVieta = poRP.indexOf(pardavejas);
                                if (pardavejoVieta !== -1) {
                                    produktas = poRP.substring(0, pardavejoVieta).trim();
                                } else {
                                    produktas = poRP;
                                }
                            } else {
                                if (uzsNr !== "") {
                                    const nrVieta = poRP.indexOf(uzsNr);
                                    if (nrVieta !== -1) {
                                        produktas = poRP.substring(0, nrVieta).trim();
                                    } else {
                                        produktas = poRP;
                                    }
                                } else {
                                    produktas = poRP;
                                }
                            }
                            produktas = produktas.replace(/[,.\s]+$/, "").trim();
                        }

                        const kategorija = (pLower.includes("savininko reklama") || pLower.includes("lt advert") || pardavejas === "") ? "Kita" : "Komercinis";
                        
                        const kainaSav = parseFloat(r['1 sav. nuomos GROSS kaina']) || 0;
                        const grossTotal = (sDates.length * (kainaSav / 7));

                        return {
                            'Stendo vietos kodas': r['Kodas'],
                            'Stendo tipas': r['Tipas'],
                            'Miestas': r['Miestas'],
                            'Adresas': r['Pardavimų adresas'],
                            'Reklamuotojas': formatuotiReklamuotoja(pStr),
                            'Prekės ženklas': pStr,
                            'Reklamuojamas produktas': produktas,
                            'Pardavėjas': pardavejas,
                            'Užsakymo numeris': uzsNr,
                            'Kategorija': kategorija,
                            'Data nuo': sDates[0],
                            'Data iki': sDates[sDates.length - 1],
                            'Pusė': gautiPuse(r['Kodas'], r['Tipas']),
                            'GROSS Eur': kategorija === "Kita" ? 0 : Number(grossTotal.toFixed(2))
                        };
                    });

                    const ws = XLSX.utils.json_to_sheet(finalData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "TNS Ataskaita");
                    
                    XLSX.writeFile(wb, `TNS ataskaita [už ${year} ${month}].xlsx`);
                    
                    resultInfo.innerText = `Ataskaita paruošta: suformuota ${finalData.length} eilučių`;
                    goToStep(3);
                } catch (err) { console.error(err); alert('Klaida apdorojant duomenis.'); }
                finally { loadingOverlay.classList.add('hidden'); }
            }, 100);
        };

        restartBtn.onclick = () => { 
            nustatytiPraeitaMenesi(); 
            goToStep(2); 
        };
    </script>
</body>
</html>
