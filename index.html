<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNS Ataskaitos Formavimas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .loader-spin {
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 text-slate-900 relative">

    <!-- Krovimosi langas -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex flex-col items-center justify-center text-white text-center px-4">
        <div class="bg-white p-8 rounded-3xl flex flex-col items-center shadow-2xl max-w-xs w-full">
            <div class="relative mb-4">
                <i data-lucide="loader-2" class="w-14 h-14 text-emerald-600 animate-spin"></i>
            </div>
            <p id="loadingTitle" class="text-slate-800 font-bold text-xl mb-1">Generuojama TNS ataskaita</p>
            <p id="loadingSubtitle" class="text-slate-500 text-sm">Prašome palaukti...</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- Antraštė -->
        <div class="flex items-center gap-3 mb-8">
            <div class="bg-emerald-600 p-3 rounded-xl shadow-lg shadow-emerald-200">
                <i data-lucide="file-spreadsheet" class="text-white w-8 h-8"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-slate-800">TNS Ataskaitos Formavimas</h1>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
            
            <!-- 1. Sugeneravimo instrukcija -->
            <div class="mb-10 p-6 bg-emerald-50 border border-emerald-100 rounded-2xl">
                <h3 class="text-sm font-bold text-emerald-800 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i> 1. Sugeneruokite failą Eksportas_statika.xls
                </h3>
                <ul class="text-sm text-emerald-700 space-y-2 list-none pl-1">
                    <li class="flex items-start gap-2">
                        <span class="text-emerald-400">•</span>
                        <span>Atsidarykite <a href="https://lta-eilutes.vercel.app/" target="_blank" class="underline font-semibold hover:text-emerald-900 transition-colors">lta-eilutes.vercel.app</a></span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-emerald-400">•</span>
                        <span>Prisijunkite prie sistemos</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-emerald-400">•</span>
                        <span>Pasirinkite skiltį <strong>„Statika“</strong></span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-emerald-400">•</span>
                        <span>Įkelkite naujausią <strong>Uzimtumas L..xls</strong> failą</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-emerald-400">•</span>
                        <span>Palaukite, kol sistema sugeneruos failą <strong>Eksportas_statika.xls</strong></span>
                    </li>
                </ul>
            </div>

            <!-- 2. Failo įkėlimas -->
            <div class="mb-8">
                <label class="block text-sm font-semibold text-slate-700 mb-2 uppercase tracking-wider">
                    2. Įkelkite <span class="text-emerald-600 font-bold">Eksportas_statika.xls</span> failą
                </label>
                <div id="dropZone" class="border-2 border-dashed border-slate-200 rounded-xl p-10 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-400 hover:bg-emerald-50 transition-all bg-white group">
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
                    <div id="uploadPrompt" class="flex flex-col items-center">
                        <div class="bg-slate-50 p-4 rounded-full mb-4 group-hover:bg-emerald-100 transition-colors">
                            <i data-lucide="upload" class="text-slate-400 group-hover:text-emerald-600 w-10 h-10 transition-colors"></i>
                        </div>
                        <span class="text-slate-600 text-center font-medium">Įkelti failą čia</span>
                    </div>
                    <div id="fileInfo" class="hidden flex flex-col items-center">
                        <div class="bg-emerald-50 p-4 rounded-full mb-3">
                            <i data-lucide="check-circle-2" class="w-10 h-10 text-emerald-500"></i>
                        </div>
                        <span id="selectedFileName" class="font-bold text-emerald-700 text-center truncate max-w-xs"></span>
                        <button type="button" class="text-xs text-emerald-600 underline mt-2 hover:text-emerald-800">Keisti failą</button>
                    </div>
                </div>
            </div>

            <!-- 3. Konfigūracija -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2 uppercase tracking-wider">Metai</label>
                    <select id="reportYear" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none cursor-pointer">
                        <option value="2024">2024 metai</option>
                        <option value="2025">2025 metai</option>
                        <option value="2026">2026 metai</option>
                        <option value="2027">2027 metai</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2 uppercase tracking-wider">Mėnuo</label>
                    <select id="reportMonth" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none cursor-pointer">
                        <option value="1">Sausis</option>
                        <option value="2">Vasaris</option>
                        <option value="3">Kovas</option>
                        <option value="4">Balandis</option>
                        <option value="5">Gegužė</option>
                        <option value="6">Birželis</option>
                        <option value="7">Liepa</option>
                        <option value="8">Rugpjūtis</option>
                        <option value="9">Rugsėjis</option>
                        <option value="10">Spalis</option>
                        <option value="11">Lapkritis</option>
                        <option value="12">Gruodis</option>
                    </select>
                </div>
            </div>

            <!-- Būsenos pranešimas -->
            <div id="statusBox" class="hidden mb-8 p-4 rounded-lg flex items-start gap-3 border shadow-sm">
                <i id="statusIcon" class="w-5 h-5 mt-0.5 shrink-0"></i>
                <p id="statusText" class="text-sm font-medium"></p>
            </div>

            <!-- Veiksmo mygtukas -->
            <button id="generateBtn" disabled class="w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-all bg-slate-200 text-slate-400 cursor-not-allowed">
                <i data-lucide="file-down" class="w-6 h-6"></i>
                Generuoti TNS Ataskaitą
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let uploadedData = null;
        const STATUSAI = ["UAB", "AB", "IĮ", "VŠĮ", "AS", "VIEŠOJI ĮSTAIGA"];

        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const fileInfo = document.getElementById('fileInfo');
        const selectedFileName = document.getElementById('selectedFileName');
        const generateBtn = document.getElementById('generateBtn');
        const statusBox = document.getElementById('statusBox');
        const statusText = document.getElementById('statusText');
        const statusIcon = document.getElementById('statusIcon');
        const reportYear = document.getElementById('reportYear');
        const reportMonth = document.getElementById('reportMonth');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingSubtitle = document.getElementById('loadingSubtitle');

        const nustatytiPraeitaMenesi = () => {
            const d = new Date();
            d.setMonth(d.getMonth() - 1);
            const pMenesis = d.getMonth() + 1;
            const pMetai = d.getFullYear();
            reportYear.value = pMetai;
            reportMonth.value = pMenesis;
        };

        nustatytiPraeitaMenesi();

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        };

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-emerald-400', 'bg-emerald-50'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-emerald-400', 'bg-emerald-50'); };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-emerald-400', 'bg-emerald-50');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        };

        const formatuotiReklamuotoja = (tekstas) => {
            if (!tekstas) return "";
            const dalys = tekstas.split(",").map(d => d.trim());
            const pirma = dalys[0] || "";
            const antra = dalys.length > 1 ? dalys[1] : "";
            const antraValyta = antra.toUpperCase().replace(/\./g, "");
            if (STATUSAI.includes(antraValyta)) return `${pirma}, ${antra}`;
            return pirma;
        };

        const formatuotiProdukta = (tekstas) => {
            if (!tekstas) return "";
            const rpVariantas = tekstas.includes("R. P.") ? "R. P." : (tekstas.includes("R.P.") ? "R.P." : null);
            if (!rpVariantas) return ""; 
            const dalysPoRP = tekstas.split(rpVariantas);
            let poRP = dalysPoRP.length > 1 ? dalysPoRP[1].trim() : "";
            if (poRP.startsWith(":")) poRP = poRP.substring(1).trim();
            const dalys = poRP.split(",");
            if (dalys.length > 1) return dalys.slice(0, -1).join(",").trim();
            return dalys[0].trim();
        };

        const gautiPuse = (kodas, tipas) => {
            const k = String(kodas).trim().toUpperCase();
            const t = String(tipas).trim().toLowerCase();
            if (t.includes('siena')) return 1;
            if (t.includes('vitrina')) {
                const match = k.match(/\.(\d)$/);
                if (match) return parseInt(match[1]);
                return 1;
            }
            if (t.includes('kolona')) return "1, 2, 3";
            if (t.includes('stotelė')) return 1;
            const paskutinisChar = k.slice(-1);
            if (paskutinisChar === 'A' || paskutinisChar === '1' || k.endsWith(' A')) return 1;
            if (paskutinisChar === 'B' || paskutinisChar === '2' || k.endsWith(' B')) return 2;
            return 1;
        };

        function showStatus(message, type) {
            statusBox.classList.remove('hidden', 'bg-emerald-100', 'text-emerald-800', 'border-emerald-200', 'bg-red-100', 'text-red-800', 'border-red-200');
            if (type === 'success') {
                statusBox.classList.add('bg-emerald-100', 'text-emerald-800', 'border-emerald-200');
                statusIcon.setAttribute('data-lucide', 'check-circle-2');
            } else {
                statusBox.classList.add('bg-red-100', 'text-red-800', 'border-red-200');
                statusIcon.setAttribute('data-lucide', 'alert-circle');
            }
            statusText.innerText = message;
            lucide.createIcons();
        }

        function handleFile(file) {
            if (!file) return;
            loadingTitle.innerText = "Failas apdorojamas.....";
            loadingSubtitle.innerText = "Nuskaitomi duomenys";
            loadingOverlay.classList.remove('hidden');

            setTimeout(() => {
                selectedFileName.innerText = file.name;
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        uploadedData = XLSX.utils.sheet_to_json(sheet);
                        
                        uploadPrompt.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                        generateBtn.disabled = false;
                        generateBtn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                        generateBtn.classList.add('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                        
                        showStatus('Failas sėkmingai įkeltas.', 'success');
                    } catch (err) {
                        console.error(err);
                        showStatus('Klaida nuskaitant failą.', 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                };
                reader.readAsBinaryString(file);
            }, 100);
        }

        generateBtn.onclick = () => {
            if (!uploadedData) return;
            loadingTitle.innerText = "Generuojama TNS ataskaita";
            loadingSubtitle.innerText = "Prašome palaukti...";
            loadingOverlay.classList.remove('hidden');

            setTimeout(() => {
                try {
                    const year = reportYear.value;
                    const month = reportMonth.value.padStart(2, '0');
                    const targetPrefix = `${year}-${month}`;

                    // Reguliari išraiška bet kokiems inicialams (pvz. V. P. arba V.P.)
                    const inicialuRegex = /[A-ZĄČĘĖĮŠŲŪŽ]\.\s?[A-ZĄČĘĖĮŠŲŪŽ]\./g;

                    const filtered = uploadedData.filter(row => {
                        const d = row['Data'];
                        const p = row['Pardavimas'];
                        
                        // 1. Tikriname datą
                        const isCorrectMonth = d && String(d).startsWith(targetPrefix);
                        if (!isCorrectMonth) return false;

                        // 2. Tikriname ar užsakymas yra komercinis (turi vadybininko inicialus)
                        if (!p || String(p).trim() === "" || String(p).trim() === "0") return false;
                        
                        const pStr = String(p);
                        const visiInicialai = pStr.match(inicialuRegex) || [];
                        
                        // Iš visų rastų inicialų atfiltruojame tuos, kurie NĖRA "RP"
                        const vadybininkai = visiInicialai.filter(init => {
                            const clean = init.replace(/\s/g, '').toUpperCase();
                            return clean !== 'RP';
                        });
                        
                        // Užsakymas komercinis tik jei po filtravimo liko bent vieni inicialai (vadybininko)
                        return vadybininkai.length > 0;
                    });

                    if (filtered.length === 0) {
                        showStatus(`Nerasta komercinių užsakymų (su vadybininko inicialais) už ${year}-${month}.`, 'error');
                        loadingOverlay.classList.add('hidden');
                        return;
                    }

                    const sorted = [...filtered].sort((a, b) => {
                        const codeA = String(a['Kodas']);
                        const codeB = String(b['Kodas']);
                        if (codeA !== codeB) return codeA.localeCompare(codeB, undefined, { numeric: true, sensitivity: 'base' });
                        return String(a['Data']).localeCompare(String(b['Data']));
                    });

                    const groups = [];
                    if (sorted.length > 0) {
                        let currentGroup = {
                            kodas: sorted[0]['Kodas'],
                            pardavimas: sorted[0]['Pardavimas'],
                            miestas: sorted[0]['Miestas'],
                            adresas: sorted[0]['Pardavimų adresas'],
                            tipas: sorted[0]['Tipas'],
                            kainaSav: parseFloat(sorted[0]['1 sav. nuomos GROSS kaina']) || 0,
                            datos: [sorted[0]['Data']]
                        };

                        for (let i = 1; i < sorted.length; i++) {
                            const row = sorted[i];
                            if (row['Kodas'] === currentGroup.kodas && row['Pardavimas'] === currentGroup.pardavimas) {
                                currentGroup.datos.push(row['Data']);
                            } else {
                                groups.push(currentGroup);
                                currentGroup = {
                                    kodas: row['Kodas'],
                                    pardavimas: row['Pardavimas'],
                                    miestas: row['Miestas'],
                                    adresas: row['Pardavimų adresas'],
                                    tipas: row['Tipas'],
                                    kainaSav: parseFloat(row['1 sav. nuomos GROSS kaina']) || 0,
                                    datos: [row['Data']]
                                };
                            }
                        }
                        groups.push(currentGroup);
                    }

                    const tnsRows = groups.map(g => {
                        const sDates = g.datos.sort();
                        const puse = gautiPuse(g.kodas, g.tipas);
                        const gross = (sDates.length * (g.kainaSav / 7));

                        return {
                            'Stendo vietos kodas': g.kodas,
                            'Stendo tipas': g.tipas,
                            'Miestas': g.miestas,
                            'Adresas': g.adresas,
                            'Reklamuotojas': formatuotiReklamuotoja(g.pardavimas),
                            'Prekės ženklas': g.pardavimas,
                            'Reklamuojamas produktas': formatuotiProdukta(g.pardavimas) || g.pardavimas,
                            'Data nuo': sDates[0],
                            'Data iki': sDates[sDates.length - 1],
                            'Pusė': puse,
                            'GROSS įkainis Eur': Number(gross.toFixed(2))
                        };
                    });

                    const ws = XLSX.utils.json_to_sheet(tnsRows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "TNS Ataskaita");
                    XLSX.writeFile(wb, `TNS_Ataskaita_${year}_${month}.xlsx`);
                    
                    showStatus(`Sugeneruota ${tnsRows.length} eilučių.`, 'success');
                } catch (err) {
                    console.error(err);
                    showStatus('Klaida generuojant ataskaitą.', 'error');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }, 500);
        };
    </script>
</body>
</html>
